# ezbookkeeping 账户功能分析报告

## 1. 概述
ezbookkeeping 的账户功能是整个财务管理系统的核心。它不仅记录资产和负债的状态，还通过层级结构和多种账户类别支持灵活的记账需求。账户与账目（Transactions）紧密关联，动态反映用户的财务状况。

## 2. 账户结构

### 2.1 账户类型 (Account Types)
系统支持两种主要的账户组织形式：
- **单账户 (Single Account)**：最基本的账户单元，直接持有余额和记录交易。
- **多子账户 (Multi-sub accounts)**：作为容器使用的父账户，包含多个子账户。父账户本身不直接记录交易（交易记录在子账户上），但常用于逻辑分组。

### 2.2 账户层级 (Hierarchy)
- **一级账户 (Level-one Account)**：`ParentAccountId` 为 0 的账户。
- **子账户 (Sub-account)**：关联到一级账户的账户。目前系统支持两级结构（父-子）。

### 2.3 账户类别 (Account Categories)
账户被划分为不同的类别，并归类为 **资产 (Asset)** 或 **负债 (Liability)**：

| 类别 | 归类 | 描述 |
| :--- | :--- | :--- |
| 现金 (Cash) | 资产 | 实物货币 |
| 借记卡 (Checking Account) | 资产 | 银行活期账户 |
| 信用卡 (Credit Card) | 负债 | 需还款的信用额度 |
| 虚拟账户 (Virtual) | 资产 | 如支付宝、微信余额 |
| 债务 (Debt) | 负债 | 欠他人的款项 |
| 应收款 (Receivables) | 资产 | 他人欠款 |
| 投资 (Investment) | 资产 | 股票、基金等 |
| 储蓄账户 (Savings Account) | 资产 | 定期或专门储蓄 |
| 定期存单 (CD) | 资产 | 定期存款 |

### 2.4 核心属性
- **基本信息**：名称、图标、颜色、币种、备注。
- **状态控制**：是否隐藏（Hidden）、显示顺序（DisplayOrder）。
- **余额**：实时存储在数据库中，单位通常为最小货币单位（如分）。

---

## 3. 业务逻辑

### 3.1 余额管理
- **初始余额**：在创建账户时设置的初始余额，系统会自动生成一条类型为 `MODIFY_BALANCE`（调整余额）的系统账目。
- **动态更新**：
    - **收入 (Income)**：增加账户余额。
    - **支出 (Expense)**：减少账户余额。
    - **转账 (Transfer)**：减少源账户余额，增加目标账户余额。
- **原子性**：余额更新采用数据库层面的原子加减操作，确保在并发情况下的数据一致性。

### 3.2 账户操作逻辑
- **创建 (Create)**：支持批量创建，例如在创建“多子账户”时同时初始化多个子账户。
- **修改 (Modify)**：允许更改名称、图标等属性。对于“多子账户”，支持动态添加、修改或移除子账户。
- **隐藏 (Hide)**：隐藏后的账户不会出现在记账时的选择列表中，但历史数据保留，且在资产统计中仍可包含。
- **删除 (Delete)**：
    - 采用 **软删除 (Soft Delete)**，标记 `Deleted` 字段。
    - **删除限制**：如果账户已用于实际交易（非初始余额调整）或关联了定时任务/账目模板，则不允许删除，以保证财务数据的完整性。

### 3.3 统计与平衡
- 系统根据账户的资产/负债分类，计算总资产、总负债和净资产。
- 账户余额与所属的所有账目流水之和在逻辑上应保持一致。

---

## 4. 技术实现要点
- **后端 (Golang)**：使用 `pkg/services/accounts.go` 处理业务逻辑，通过 XORM 与数据库交互，并使用事务 (`DoTransaction`) 保证多表操作的一致性。
- **前端 (Vue.js)**：在 `src/stores/account.ts` 中管理账户状态，支持多币种转换展示。
- **唯一标识**：使用雪花算法或类似机制生成 64 位整型 UUID 作为 `AccountId`。
