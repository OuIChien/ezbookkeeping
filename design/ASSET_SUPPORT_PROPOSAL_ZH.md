# ezbookkeeping 加密货币与股票支持方案

## 1. 核心目标
使 ezbookkeeping 能够管理非货币资产（加密货币、股票、基金等），不仅记录其当前价值，还能追踪持有数量（Quantity）并根据实时市场价格自动更新总估值。

## 2. 账户结构改造方案

### 2.1 数据库字段扩展 (`Account` 表)
- **币种字段长度扩展**：目前 `Currency` 为 `VARCHAR(3)`（符合 ISO 4217 标淮）。需扩展为 `VARCHAR(10)` 以支持股票代码（如 `AAPL`, `TSLA`）和长加密货币符号（如 `SHIB`, `DOT`）。
- **余额精度定义**：
    - 现有的 `Balance` (int64) 在记录法币时通常代表“分”。
    - **建议方案**：对于非法币资产，`Balance` 字段代表 **持有数量**。为了支持高精度（如比特币的 8 位小数），约定非货币资产的 `Balance` 存储单位为 $10^{-8}$。
    - **替代方案**：在 `AccountExtend` 中增加 `Quantity` 字段，专门用于存储资产数量，而主 `Balance` 保持为折算的法币价值。

### 2.2 账户类型细化
- 维持现有的 `ACCOUNT_CATEGORY_INVESTMENT`（投资）。
- 建议在 UI 层面或 `AccountExtend` 中增加 `AssetType` 标识：
    - `FIAT`：普通法币账户。
    - `CRYPTO`：加密货币账户。
    - `STOCK`：股票/证券账户。

---

## 3. 业务逻辑改造

### 3.1 价值换算逻辑 (Valuation)
- **实时价格引入**：
    - **加密货币**：直接对接项目中已实现的加密货币价格服务（位于 `pkg/cryptocurrency`），该服务已支持从 CoinGecko, Binance 等源获取价格。
    - **股票/证券**：直接对接项目中已实现的股票价格服务（位于 `pkg/stocks`），改服务已支持从 Yahoo Finance API 或 Alpha Vantage 等源获取价格。
- **估值计算**：
    - 账户总价值 = 持有数量 (Quantity) × 实时单价 (Market Price)。
    - 系统自动将估值折算为用户的“本位币”（Default Currency）显示在资产总额中。

### 3.2 账目交易逻辑 (Transactions)
- **买入 (Purchase)**：
    - 转出账户：法币账户（减少余额）。
    - 转入账户：资产账户（增加数量）。
    - 记录单价：在交易记录的 `Comment` 或新增的 `Price` 扩展字段中记录成交单价。
- **卖出 (Sale)**：
    - 转出账户：资产账户（减少数量）。
    - 转入账户：法币账户（增加余额）。
- **分红/利息 (Dividend/Interest)**：
    - 作为 `INCOME` 记录到资产账户（增加持有量，如送股）或法币账户（如现金分红）。

---

## 4. 验证与约束
- **扩展货币验证**：更新 `pkg/validators/currency.go`，允许除了 ISO 4217 之外的自定义符号。
- **防止误删**：对于有持有量的资产账户，应加强删除限制，确保财务审计线索完整。

---

## 5. UI/UX 建议
- **资产概览**：在账户列表页，除了显示持有数量，还应在下方显示按当前汇率折算的法币金额。
- **图表展示**：在统计图中增加“资产组成”比例图，区分法币资产、加密资产和证券资产。

---

## 6. 实现步骤建议
1.  **第一步**：修改数据库 `Account` 表的 `Currency` 字段长度并更新相关验证逻辑。
2.  **第二步**：集成已有的加密货币价格服务和股票价格获取服务。
3.  **第三步**：在前端账户模型中引入“资产类型”逻辑，并对接价格服务进行估值显示。
4.  **第四步**：优化记账流程，支持“按单价/总价买入资产”的快捷操作。
